
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contextual Recommender with Vowpal Wabbit &#8212; drl-recsys</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Multi-armed Bandit for Banner Ad" href="T000348_Multi_armed_Bandit_for_Banner_Ad.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">drl-recsys</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="R984600_DRL_in_RecSys.html">
   Deep Reinforcement Learning in Recommendation Systems
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L268705_Offline_Reinforcement_Learning.html">
   Offline Reinforcement Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L732057_Markov_Decision_Process.html">
   Markov Decision Process
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  RL Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T726861_Introduction_to_Gym_toolkit.html">
   Introduction to Gym toolkit
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  RecSys Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T000348_Multi_armed_Bandit_for_Banner_Ad.html">
   Multi-armed Bandit for Banner Ad
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Contextual Recommender with Vowpal Wabbit
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T119194_Contextual_RL_Product_Recommender.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/drl-recsys/main?urlpath=tree/docs/T119194_Contextual_RL_Product_Recommender.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/drl-recsys/blob/main/docs/T119194_Contextual_RL_Product_Recommender.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#installations">
     Installations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulate-reward">
   Simulate reward
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#understanding-vw-format">
   Understanding VW format
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-a-decision">
   Getting a decision
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-set-up">
   Simulation set up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scenario-1">
   Scenario 1
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#with-learning">
     With learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#without-learning">
     Without learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scenario-2">
   Scenario 2
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tom">
     Tom
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#anna">
     Anna
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     With learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Without learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scenario-3">
   Scenario 3
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Tom
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Anna
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     With learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Without Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contextual-bandit-with-changing-context">
   Contextual bandit with changing context
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-the-context">
     Setting the context
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cost-function-util">
     Cost function util
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vowpalwabbit-format-util">
     Vowpalwabbit format util
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-context">
     Changing the context
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contextual-bandit-dash-app">
   Contextual bandit dash app
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="contextual-recommender-with-vowpal-wabbit">
<h1>Contextual Recommender with Vowpal Wabbit<a class="headerlink" href="#contextual-recommender-with-vowpal-wabbit" title="Permalink to this headline">¶</a></h1>
<p>We will simulate the scenario of personalizing news content on a site, using CB, to users. The goal is to maximize user engagement quantified by measuring click through rate (CTR).</p>
<p>Let’s recall that in a CB setting, a data point has four components,</p>
<ul class="simple">
<li><p>Context</p></li>
<li><p>Action</p></li>
<li><p>Probability of choosing action</p></li>
<li><p>Reward/cost for chosen action</p></li>
</ul>
<p>We will need to generate a context, get an action/decision for the given context and also simulate generating a reward. We have two website visitors: ‘Tom’ and ‘Anna’ Each of them may visit the website either in the morning or in the afternoon. The context is therefore (user, time_of_day). We have the option of recommending a variety of articles to Tom and Anna. Therefore, actions are the different choices of articles: “politics”, “sports”, “music”, “food”, “finance”, “health”, “cheese”. The reward is whether they click on the article or not: ‘click’ or ‘no click’.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installations">
<h3>Installations<a class="headerlink" href="#installations" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install vowpalwabbit
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vowpalwabbit</span> <span class="kn">import</span> <span class="n">pyvw</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="simulate-reward">
<h2>Simulate reward<a class="headerlink" href="#simulate-reward" title="Permalink to this headline">¶</a></h2>
<p>In the real world, we will have to learn Tom and Anna’s preferences for articles as we observe their interactions. Since this is a simulation, we will have to define Tom and Anna’s preference profile. The reward that we provide to the learner will follow this preference profile. Our hope is to see if the learner can take better and better decisions as we see more samples which in turn means we are maximizing the reward.</p>
<p>We will also modify the reward function in a few different ways and see if the CB learner picks up the changes. We will compare the CTR with and without learning.</p>
<p>VW optimizes to minimize <strong>cost which is negative of reward</strong>. Therefore, we will always pass negative of reward as cost to VW.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># VW tries to minimize loss/cost, therefore we will pass cost as -reward</span>
<span class="n">USER_LIKED_ARTICLE</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">USER_DISLIKED_ARTICLE</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
</div>
<p>The reward function below specifies that Tom likes politics in the morning and music in the afternoon whereas Anna likes sports in the morning and politics in the afternoon. It looks dense but we are just simulating our hypothetical world in the format of the feedback the learner understands: cost. If the learner recommends an article that aligns with the reward function, we give a positive reward. In our simulated world this is a click.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Tom&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;music&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
    <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Anna&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="understanding-vw-format">
<h2>Understanding VW format<a class="headerlink" href="#understanding-vw-format" title="Permalink to this headline">¶</a></h2>
<p>There are some things we need to do to get our input into a format VW understands. This function handles converting from our context as a dictionary, list of articles and the cost if there is one into the text format VW understands.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function modifies (context, action, cost, probability) to VW friendly format</span>
<span class="k">def</span> <span class="nf">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cb_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen_action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">cb_label</span>
    <span class="n">example_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;shared |User user=</span><span class="si">{}</span><span class="s2"> time_of_day=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;time_of_day&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="n">chosen_action</span><span class="p">:</span>
            <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;0:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;|Action article=</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="c1">#Strip the last newline</span>
    <span class="k">return</span> <span class="n">example_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To understand what’s going on here let’s go through an example. Here, it’s the morning and the user is Tom. There are four possible articles. So in the VW format there is one line that starts with shared, this is the shared context, followed by four lines each corresponding to an article.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;Tom&quot;</span><span class="p">,</span><span class="s2">&quot;time_of_day&quot;</span><span class="p">:</span><span class="s2">&quot;morning&quot;</span><span class="p">}</span>
<span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;politics&quot;</span><span class="p">,</span> <span class="s2">&quot;sports&quot;</span><span class="p">,</span> <span class="s2">&quot;music&quot;</span><span class="p">,</span> <span class="s2">&quot;food&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">actions</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>shared |User user=Tom time_of_day=morning
|Action article=politics 
|Action article=sports 
|Action article=music 
|Action article=food 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="getting-a-decision">
<h2>Getting a decision<a class="headerlink" href="#getting-a-decision" title="Permalink to this headline">¶</a></h2>
<p>When we call VW we get a <em>pmf</em>, <a class="reference external" href="https://en.wikipedia.org/wiki/Probability_mass_function">probability mass function</a>, as the output. Since we are incorporating exploration into our strategy, VW will give us a list of probabilities over the set of actions. This means that the probability at a given index in the list corresponds to the likelihood of picking that specific action. In order to arrive at a decision/action, we will have to sample from this list.</p>
<p>So, given a list <code class="docutils literal notranslate"><span class="pre">[0.7,</span> <span class="pre">0.1,</span> <span class="pre">0.1,</span> <span class="pre">0.1]</span></code>, we would choose the first item with a 70% chance. <code class="docutils literal notranslate"><span class="pre">sample_custom_pmf</span></code> takes such a list and gives us the index it chose and what the probability of choosing that index was.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">total</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf</span><span class="p">]</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">sum_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
        <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">prob</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sum_prob</span> <span class="o">&gt;</span> <span class="n">draw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span>
</pre></div>
</div>
</div>
</div>
<p>We have all of the information we need to choose an action for a specific user and context. To use VW to achieve this, we will do the following:</p>
<ol class="simple">
<li><p>We convert our context and actions into the text format we need</p></li>
<li><p>We pass this example to vw and get the pmf out</p></li>
<li><p>Now, we sample this pmf to get what article we will end up showing</p></li>
<li><p>Finally we return the article chosen, and the probability of choosing it (we are going to need the probability when we learn form this example)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="n">vw_text_example</span> <span class="o">=</span> <span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">actions</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">vw_text_example</span><span class="p">)</span>
    <span class="n">chosen_action_index</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actions</span><span class="p">[</span><span class="n">chosen_action_index</span><span class="p">],</span> <span class="n">prob</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="simulation-set-up">
<h2>Simulation set up<a class="headerlink" href="#simulation-set-up" title="Permalink to this headline">¶</a></h2>
<p>Now that we have done all of the setup work and know how to interface with VW, let’s simulate the world of Tom and Anna. The scenario is they go to a website and are shown an article. Remember that the reward function allows us to define the worlds reaction to what VW recommends.</p>
<p>We will choose between Tom and Anna uniformly at random and also choose their time of visit uniformly at random. You can think of this as us tossing a coin to choose between Tom and Anna (Anna if heads and Tom if tails) and another coin toss for choosing time of day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;Anna&#39;</span><span class="p">]</span>
<span class="n">times_of_day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">]</span>
<span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;politics&quot;</span><span class="p">,</span> <span class="s2">&quot;sports&quot;</span><span class="p">,</span> <span class="s2">&quot;music&quot;</span><span class="p">,</span> <span class="s2">&quot;food&quot;</span><span class="p">,</span> <span class="s2">&quot;finance&quot;</span><span class="p">,</span> <span class="s2">&quot;health&quot;</span><span class="p">,</span> <span class="s2">&quot;camping&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choose_time_of_day</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)</span>

<span class="c1"># display preference matrix</span>
<span class="k">def</span> <span class="nf">get_preference_matrix</span><span class="p">(</span><span class="n">cost_fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_grid</span><span class="p">(</span><span class="n">data_dict</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">expand_grid</span><span class="p">({</span><span class="s1">&#39;users&#39;</span><span class="p">:</span><span class="n">users</span><span class="p">,</span> <span class="s1">&#39;times_of_day&#39;</span><span class="p">:</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="p">})</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">cost_fun</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;times_of_day&#39;</span><span class="p">],</span> 
            <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;actions&#39;</span><span class="p">,</span> 
            <span class="n">values</span><span class="o">=</span><span class="s1">&#39;cost&#39;</span><span class="p">)</span>

<span class="n">get_preference_matrix</span><span class="p">(</span><span class="n">get_cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actions</th>
      <th>camping</th>
      <th>finance</th>
      <th>food</th>
      <th>health</th>
      <th>music</th>
      <th>politics</th>
      <th>sports</th>
    </tr>
    <tr>
      <th>users</th>
      <th>times_of_day</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Anna</th>
      <th>afternoon</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>morning</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Tom</th>
      <th>afternoon</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>morning</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We will instantiate a CB learner in VW and then simulate Tom and Anna’s website visits <code class="docutils literal notranslate"><span class="pre">num_iterations</span></code> number of times. In each visit, we:</p>
<ol class="simple">
<li><p>Decide between Tom and Anna</p></li>
<li><p>Decide time of day</p></li>
<li><p>Pass context i.e. (user, time of day) to learner to get action i.e. article recommendation and probability of choosing action</p></li>
<li><p>Receive reward i.e. see if user clicked or not. Remember that cost is just negative reward.</p></li>
<li><p>Format context, action, probability, reward in VW format</p></li>
<li><p>Learn from the example</p>
<ul class="simple">
<li><p>VW <em>reduces</em> a CB problem to a cost sensitive multiclass classification problem.</p></li>
</ul>
</li>
</ol>
<p>This is the same for every one of our simulations, so we define the process in the <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> function. The cost function must be supplied as this is essentially us simulating how the world works.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_function</span><span class="p">,</span> <span class="n">do_learn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">cost_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># 1. In each simulation choose a user</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="c1"># 2. Choose time of day for a given user</span>
        <span class="n">time_of_day</span> <span class="o">=</span> <span class="n">choose_time_of_day</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)</span>

        <span class="c1"># 3. Pass context to vw to get an action</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">time_of_day</span><span class="p">}</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

        <span class="c1"># 4. Get cost of the action we chose</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">cost_sum</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="k">if</span> <span class="n">do_learn</span><span class="p">:</span>
            <span class="c1"># 5. Inform VW of what happened so we can learn from it</span>
            <span class="n">vw_format</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span><span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
            <span class="c1"># 6. Learn</span>
            <span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>

        <span class="c1"># We negate this so that on the plot instead of minimizing cost, we are maximizing reward</span>
        <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">cost_sum</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctr</span>
</pre></div>
</div>
</div>
</div>
<p>We want to be able to visualize what is occurring, so we are going to plot the click through rate over each iteration of the simulation. If VW is showing actions the get rewards the ctr will be higher. Below is a little utility function to make showing the plot easier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_iterations</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ctr</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;num_iterations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ctr&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="scenario-1">
<h2>Scenario 1<a class="headerlink" href="#scenario-1" title="Permalink to this headline">¶</a></h2>
<p>We will use the first reward function <code class="docutils literal notranslate"><span class="pre">get_cost</span></code> and assume that Tom and Anna do not change their preferences over time and see what happens to user engagement as we learn. We will also see what happens when there is no learning. We will use the “no learning” case as our baseline to compare to.</p>
<div class="section" id="with-learning">
<h3>With learning<a class="headerlink" href="#with-learning" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_26_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_26_0.png" />
</div>
</div>
<p>Aside: interactions</p>
<p>You’ll notice in the arguments we supply to VW, <strong>we include <code class="docutils literal notranslate"><span class="pre">-q</span> <span class="pre">UA</span></code></strong>. This is telling VW to create additional features which are the features in the (U)ser namespace and (A)ction namespaces multiplied together. This allows us to learn the interaction between when certain actions are good in certain times of days and for particular users. If we didn’t do that, the learning wouldn’t really work. We can see that in action below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW but without -q</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_28_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_28_0.png" />
</div>
</div>
</div>
<div class="section" id="without-learning">
<h3>Without learning<a class="headerlink" href="#without-learning" title="Permalink to this headline">¶</a></h3>
<p>Let’s do the same thing again (but with <code class="docutils literal notranslate"><span class="pre">-q</span></code>, but this time show the effect if we don’t learn from what happens. The ctr never improves are we just hover around 0.2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">,</span> <span class="n">do_learn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_30_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_30_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="scenario-2">
<h2>Scenario 2<a class="headerlink" href="#scenario-2" title="Permalink to this headline">¶</a></h2>
<p>In the real world people’s preferences change over time. So now in the simulation we are going to incorporate two different cost functions, and swap over to the second one halfway through. Below is a a table of the new reward function we are going to use, <code class="docutils literal notranslate"><span class="pre">get_cost_1</span></code>:</p>
<div class="section" id="tom">
<h3>Tom<a class="headerlink" href="#tom" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost</span></code></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost_new1</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><strong>Morning</strong></p></td>
<td class="text-align:center"><p>Politics</p></td>
<td class="text-align:center"><p>Politics</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><strong>Afternoon</strong></p></td>
<td class="text-align:center"><p>Music</p></td>
<td class="text-align:center"><p>Sports</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="anna">
<h3>Anna<a class="headerlink" href="#anna" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost</span></code></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost_new1</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><strong>Morning</strong></p></td>
<td class="text-align:center"><p>Sports</p></td>
<td class="text-align:center"><p>Sports</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><strong>Afternoon</strong></p></td>
<td class="text-align:center"><p>Politics</p></td>
<td class="text-align:center"><p>Sports</p></td>
</tr>
</tbody>
</table>
<p>This reward function is still working with actions that the learner has seen previously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cost_new1</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Tom&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
    <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Anna&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
        
<span class="n">get_preference_matrix</span><span class="p">(</span><span class="n">get_cost_new1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actions</th>
      <th>camping</th>
      <th>finance</th>
      <th>food</th>
      <th>health</th>
      <th>music</th>
      <th>politics</th>
      <th>sports</th>
    </tr>
    <tr>
      <th>users</th>
      <th>times_of_day</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Anna</th>
      <th>afternoon</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>morning</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Tom</th>
      <th>afternoon</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>morning</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To make it easy to show the effect of the cost function changing we are going to modify the <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> function. It is a little less readable now, but it supports accepting a list of cost functions and it will operate over each cost function in turn. This is perfect for what we need.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">cost_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>
    <span class="k">for</span> <span class="n">cost_function</span> <span class="ow">in</span> <span class="n">cost_functions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_counter</span><span class="p">,</span> <span class="n">end_counter</span><span class="p">):</span>
            <span class="c1"># 1. in each simulation choose a user</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
            <span class="c1"># 2. choose time of day for a given user</span>
            <span class="n">time_of_day</span> <span class="o">=</span> <span class="n">choose_time_of_day</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)</span>

            <span class="c1"># Construct context based on chosen user and time of day</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">time_of_day</span><span class="p">}</span>

            <span class="c1"># 3. Use the get_action function we defined earlier</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

            <span class="c1"># 4. Get cost of the action we chose</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">cost_sum</span> <span class="o">+=</span> <span class="n">cost</span>

            <span class="k">if</span> <span class="n">do_learn</span><span class="p">:</span>
                <span class="c1"># 5. Inform VW of what happened so we can learn from it</span>
                <span class="n">vw_format</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span><span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
                <span class="c1"># 6. Learn</span>
                <span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>

            <span class="c1"># We negate this so that on the plot instead of minimizing cost, we are maximizing reward</span>
            <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">cost_sum</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
        <span class="n">start_counter</span> <span class="o">=</span> <span class="n">end_counter</span>
        <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">cost_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>
    <span class="k">for</span> <span class="n">cost_function</span> <span class="ow">in</span> <span class="n">cost_functions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_counter</span><span class="p">,</span> <span class="n">end_counter</span><span class="p">):</span>
            <span class="c1"># 1. in each simulation choose a user</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
            <span class="c1"># 2. choose time of day for a given user</span>
            <span class="n">time_of_day</span> <span class="o">=</span> <span class="n">choose_time_of_day</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)</span>

            <span class="c1"># Construct context based on chosen user and time of day</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">time_of_day</span><span class="p">}</span>

            <span class="c1"># 3. Use the get_action function we defined earlier</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

            <span class="c1"># 4. Get cost of the action we chose</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">cost_sum</span> <span class="o">+=</span> <span class="n">cost</span>

            <span class="k">if</span> <span class="n">do_learn</span><span class="p">:</span>
                <span class="c1"># 5. Inform VW of what happened so we can learn from it</span>
                <span class="n">vw_format</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span><span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
                <span class="c1"># 6. Learn</span>
                <span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>

            <span class="c1"># We negate this so that on the plot instead of minimizing cost, we are maximizing reward</span>
            <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">cost_sum</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
        <span class="n">start_counter</span> <span class="o">=</span> <span class="n">end_counter</span>
        <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>

    <span class="k">return</span> <span class="n">ctr</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>With learning<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Let us now switch to the second reward function after a few samples (running the first reward function). Recall that this reward function changes the preferences of the web users but it is still working with the same action space as before. We should see the learner pick up these changes and optimize towards the new preferences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use first reward function initially and then switch to second reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new1</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_37_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_37_0.png" />
</div>
</div>
<p><strong>Note:</strong> The initial spike in CTR depends on the rewards received for the first few examples. When you run on your own, you may see something different initially because our simulator is designed to have randomness.</p>
</div>
<div class="section" id="id2">
<h3>Without learning<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not learn</span>
<span class="c1"># use first reward function initially and then switch to second reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new1</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_39_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_39_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="scenario-3">
<h2>Scenario 3<a class="headerlink" href="#scenario-3" title="Permalink to this headline">¶</a></h2>
<p>In this scenario we are going to start rewarding actions that have never seen a reward previously when we change the cost function.</p>
<div class="section" id="id3">
<h3>Tom<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost</span></code></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost_new2</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><strong>Morning</strong></p></td>
<td class="text-align:center"><p>Politics</p></td>
<td class="text-align:center"><p>Politics</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><strong>Afternoon</strong></p></td>
<td class="text-align:center"><p>Music</p></td>
<td class="text-align:center"><p>Food</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h3>Anna<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost</span></code></p></th>
<th class="text-align:center head"><p><code class="docutils literal notranslate"><span class="pre">get_cost_new2</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><strong>Morning</strong></p></td>
<td class="text-align:center"><p>Sports</p></td>
<td class="text-align:center"><p>Food</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><strong>Afternoon</strong></p></td>
<td class="text-align:center"><p>Politics</p></td>
<td class="text-align:center"><p>Food</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cost_new2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Tom&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;food&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
    <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Anna&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;morning&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;food&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;afternoon&quot;</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;food&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>With learning<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Let us now switch to the third reward function after a few samples (running the first reward function). Recall that this reward function changes the preferences of the users and is working with a <strong>different</strong> action space than before. We should see the learner pick up these changes and optimize towards the new preferences</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use first reward function initially and then switch to third reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new2</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_43_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_43_0.png" />
</div>
</div>
</div>
<div class="section" id="id6">
<h3>Without Learning<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not learn</span>
<span class="c1"># use first reward function initially and then switch to third reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new2</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">times_of_day</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_45_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_45_0.png" />
</div>
</div>
<p>This section aimed at showcasing a real world scenario where contextual bandit algorithms can be used. We were able to take a context and set of actions and learn what actions worked best for a given context. We saw that the learner was able to respond rapidly to changes in the world.  We showed that allowing the learner to interact with the world resulted in higher rewards than the no learning baseline. We worked with simplistic features. VW supports high dimensional sparse features, different exploration algorithms and policy evaluation approaches.</p>
</div>
</div>
<div class="section" id="contextual-bandit-with-changing-context">
<h2>Contextual bandit with changing context<a class="headerlink" href="#contextual-bandit-with-changing-context" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Customizing the context and changing it midway to see how fast the agent can adapt to the new context and start recommending better products as per the context</p>
</div></blockquote>
<div class="section" id="setting-the-context">
<h3>Setting the context<a class="headerlink" href="#setting-the-context" title="Permalink to this headline">¶</a></h3>
<p>We have 3 users and 6 items. Context 1 is time of day - morning and evening. Context 2 is season - summer and winter.</p>
<p>Ground truth rules:</p>
<ol class="simple">
<li><p>User 1 likes Item 1 in morning, and Item 6 in summer</p></li>
<li><p>User 2 likes Item 2 in winter, and Item 5 in summer morning</p></li>
<li><p>User 3 likes Item 2 in morning, Item 3 in evening, and item 4 in winter morning</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USER_LIKED_ARTICLE</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">USER_DISLIKED_ARTICLE</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
<span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Item1&#39;</span><span class="p">,</span><span class="s1">&#39;Item2&#39;</span><span class="p">,</span><span class="s1">&#39;Item3&#39;</span><span class="p">,</span><span class="s1">&#39;Item4&#39;</span><span class="p">,</span><span class="s1">&#39;Item5&#39;</span><span class="p">,</span><span class="s1">&#39;Item6&#39;</span><span class="p">]</span>
<span class="n">context1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span><span class="s1">&#39;evening&#39;</span><span class="p">]</span>
<span class="n">context2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;summer&#39;</span><span class="p">,</span><span class="s1">&#39;winter&#39;</span><span class="p">]</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#user 1 likes Item 1 in morning, and Item 6 in summer</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item1&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;summer&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item6&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#user 2 likes Item 2 in winter, and Item 5 in summer morning</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;winter&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item2&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;summer&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item5&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


<span class="c1">#user 3 likes Item 2 in morning, Item 3 in evening, and item 4 in winter morning</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item2&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;evening&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item3&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;winter&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item4&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">context</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>

<span class="n">contextdf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">contextdf</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 0    60
-1    12
Name: cost, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cost-function-util">
<h3>Cost function util<a class="headerlink" href="#cost-function-util" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">contextdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">action</span><span class="p">),</span> \
            <span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_cost</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;context1&#39;</span><span class="p">:</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span><span class="s1">&#39;context2&#39;</span><span class="p">:</span><span class="s1">&#39;summer&#39;</span><span class="p">},</span><span class="s1">&#39;Item2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="vowpalwabbit-format-util">
<h3>Vowpalwabbit format util<a class="headerlink" href="#vowpalwabbit-format-util" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function modifies (context, action, cost, probability) to VW friendly format</span>
<span class="k">def</span> <span class="nf">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cb_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen_action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">cb_label</span>
    <span class="n">example_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;shared |User users=</span><span class="si">{}</span><span class="s2"> context1=</span><span class="si">{}</span><span class="s2"> context2=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context1&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context2&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="n">chosen_action</span><span class="p">:</span>
            <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;0:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;|Action items=</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="c1">#Strip the last newline</span>
    <span class="k">return</span> <span class="n">example_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span><span class="p">,</span><span class="s2">&quot;context1&quot;</span><span class="p">:</span><span class="s2">&quot;morning&quot;</span><span class="p">,</span><span class="s2">&quot;context2&quot;</span><span class="p">:</span><span class="s2">&quot;summer&quot;</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">items</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>shared |User users=A context1=morning context2=summer
|Action items=Item1 
|Action items=Item2 
|Action items=Item3 
|Action items=Item4 
|Action items=Item5 
|Action items=Item6 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf</span><span class="p">]</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">sum_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
        <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">prob</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sum_prob</span> <span class="o">&gt;</span> <span class="n">draw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="n">vw_text_example</span> <span class="o">=</span> <span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">actions</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">vw_text_example</span><span class="p">)</span>
    <span class="n">chosen_action_index</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actions</span><span class="p">[</span><span class="n">chosen_action_index</span><span class="p">],</span> <span class="n">prob</span>


<span class="k">def</span> <span class="nf">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choose_context1</span><span class="p">(</span><span class="n">context1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choose_context2</span><span class="p">(</span><span class="n">context2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">contexts1</span><span class="p">,</span> <span class="n">contexts2</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_function</span><span class="p">,</span> <span class="n">do_learn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">cost_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="n">context1</span> <span class="o">=</span> <span class="n">choose_context1</span><span class="p">(</span><span class="n">contexts1</span><span class="p">)</span>
        <span class="n">context2</span> <span class="o">=</span> <span class="n">choose_context2</span><span class="p">(</span><span class="n">contexts2</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">:</span> <span class="n">context1</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">:</span> <span class="n">context2</span><span class="p">}</span>
        <span class="c1"># print(context)</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
        <span class="c1"># print(action, prob)</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="c1"># print(cost)</span>
        <span class="n">cost_sum</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="k">if</span> <span class="n">do_learn</span><span class="p">:</span>
            <span class="c1"># 5. Inform VW of what happened so we can learn from it</span>
            <span class="n">vw_format</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span><span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
            <span class="c1"># 6. Learn</span>
            <span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>
            <span class="c1"># 7. Let VW know you&#39;re done with these objects</span>
            <span class="n">vw</span><span class="o">.</span><span class="n">finish_example</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>

        <span class="c1"># We negate this so that on the plot instead of minimizing cost, we are maximizing reward</span>
        <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">cost_sum</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctr</span>


<span class="k">def</span> <span class="nf">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_iterations</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ctr</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;num_iterations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ctr&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_61_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_61_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW but without -q</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_62_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_62_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">get_cost</span><span class="p">,</span> <span class="n">do_learn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_63_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_63_0.png" />
</div>
</div>
</div>
<div class="section" id="changing-the-context">
<h3>Changing the context<a class="headerlink" href="#changing-the-context" title="Permalink to this headline">¶</a></h3>
<p>Updated ground truth rules:</p>
<ol class="simple">
<li><p>User 1 likes Item 2 in morning, and Item 5 in summer</p></li>
<li><p>User 2 likes Item 2 in summer, and Item 5 in morning</p></li>
<li><p>User 3 likes Item 4 in morning, Item 3 in evening, and item 4 in winter evening</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
<span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Item1&#39;</span><span class="p">,</span><span class="s1">&#39;Item2&#39;</span><span class="p">,</span><span class="s1">&#39;Item3&#39;</span><span class="p">,</span><span class="s1">&#39;Item4&#39;</span><span class="p">,</span><span class="s1">&#39;Item5&#39;</span><span class="p">,</span><span class="s1">&#39;Item6&#39;</span><span class="p">]</span>
<span class="n">context1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span><span class="s1">&#39;evening&#39;</span><span class="p">]</span>
<span class="n">context2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;summer&#39;</span><span class="p">,</span><span class="s1">&#39;winter&#39;</span><span class="p">]</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#user 1 likes Item 2 in morning, and Item 5 in summer</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item2&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;summer&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item5&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#user 2 likes Item 2 in summer, and Item 5 in morning</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;summer&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item2&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item5&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


<span class="c1">#user 3 likes Item 4 in morning, Item 3 in evening, and item 4 in winter evening</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;morning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item4&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;evening&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item3&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">context</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">context</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="s1">&#39;evening&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="s1">&#39;winter&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Item4&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">context</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>

<span class="n">contextdf_new</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_cost_new1</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">contextdf_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">contextdf_new</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf_new</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf_new</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf_new</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">action</span><span class="p">),</span> \
            <span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">contexts1</span><span class="p">,</span> <span class="n">contexts2</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">cost_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>
    <span class="k">for</span> <span class="n">cost_function</span> <span class="ow">in</span> <span class="n">cost_functions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_counter</span><span class="p">,</span> <span class="n">end_counter</span><span class="p">):</span>
          <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
          <span class="n">context1</span> <span class="o">=</span> <span class="n">choose_context1</span><span class="p">(</span><span class="n">contexts1</span><span class="p">)</span>
          <span class="n">context2</span> <span class="o">=</span> <span class="n">choose_context2</span><span class="p">(</span><span class="n">contexts2</span><span class="p">)</span>

          <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">:</span> <span class="n">context1</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">:</span> <span class="n">context2</span><span class="p">}</span>
          
          <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
          <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
          <span class="n">cost_sum</span> <span class="o">+=</span> <span class="n">cost</span>

          <span class="k">if</span> <span class="n">do_learn</span><span class="p">:</span>
              <span class="n">vw_format</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span><span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
              <span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>

          <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">cost_sum</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
        <span class="n">start_counter</span> <span class="o">=</span> <span class="n">end_counter</span>
        <span class="n">end_counter</span> <span class="o">=</span> <span class="n">start_counter</span> <span class="o">+</span> <span class="n">num_iterations</span>

    <span class="k">return</span> <span class="n">ctr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use first reward function initially and then switch to second reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new1</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">)</span>

<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_67_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_67_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not learn</span>
<span class="c1"># use first reward function initially and then switch to second reward function</span>

<span class="c1"># Instantiate learner in VW</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>

<span class="n">num_iterations_per_cost_func</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">cost_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_cost</span><span class="p">,</span> <span class="n">get_cost_new1</span><span class="p">]</span>
<span class="n">total_iterations</span> <span class="o">=</span> <span class="n">num_iterations_per_cost_func</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_functions</span><span class="p">)</span>

<span class="n">ctr</span> <span class="o">=</span> <span class="n">run_simulation_multiple_cost_functions</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">num_iterations_per_cost_func</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">cost_functions</span><span class="p">,</span> <span class="n">do_learn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plot_ctr</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">,</span> <span class="n">ctr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T119194_Contextual_RL_Product_Recommender_68_0.png" src="_images/T119194_Contextual_RL_Product_Recommender_68_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapping_users</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Alex&#39;</span><span class="p">:</span><span class="s1">&#39;usera&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ben&#39;</span><span class="p">:</span><span class="s1">&#39;userb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cindy&#39;</span><span class="p">:</span> <span class="s1">&#39;userc&#39;</span>
<span class="p">}</span>
    
<span class="n">mapping_context1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Morning&#39;</span><span class="p">:</span><span class="s1">&#39;ctx11&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Evening&#39;</span><span class="p">:</span><span class="s1">&#39;ctx12&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">mapping_context2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Summer&#39;</span><span class="p">:</span><span class="s1">&#39;ctx21&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Winter&#39;</span><span class="p">:</span><span class="s1">&#39;ctx22&#39;</span>
<span class="p">}</span>

<span class="n">mapping_items</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Politics&#39;</span><span class="p">:</span><span class="s1">&#39;item1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Economics&#39;</span><span class="p">:</span><span class="s1">&#39;item2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Technology&#39;</span><span class="p">:</span><span class="s1">&#39;item3&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Movies&#39;</span><span class="p">:</span><span class="s1">&#39;item4&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Business&#39;</span><span class="p">:</span><span class="s1">&#39;item5&#39;</span><span class="p">,</span>
    <span class="s1">&#39;History&#39;</span><span class="p">:</span><span class="s1">&#39;item6&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_users</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">context1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_context1</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">context2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_context2</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
<span class="n">contextdf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">contextdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>users</th>
      <th>context1</th>
      <th>context2</th>
      <th>items</th>
      <th>reward</th>
      <th>cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item1</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item2</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item4</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item5</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item2</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>68</th>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>69</th>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item4</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>70</th>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item5</td>
      <td>1</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>71</th>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item6</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>72 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function modifies (context, action, cost, probability) to VW friendly format</span>
<span class="k">def</span> <span class="nf">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cb_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen_action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">cb_label</span>
    <span class="n">example_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;shared |User users=</span><span class="si">{}</span><span class="s2"> context1=</span><span class="si">{}</span><span class="s2"> context2=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context1&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context2&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="n">chosen_action</span><span class="p">:</span>
            <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;0:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;|Action items=</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="c1">#Strip the last newline</span>
    <span class="k">return</span> <span class="n">example_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf</span><span class="p">]</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">sum_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
        <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">prob</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sum_prob</span> <span class="o">&gt;</span> <span class="n">draw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span>


<span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="n">vw_text_example</span> <span class="o">=</span> <span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">vw_text_example</span><span class="p">)</span>
    <span class="n">chosen_action_index</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actions</span><span class="p">[</span><span class="n">chosen_action_index</span><span class="p">],</span> <span class="n">prob</span>


<span class="k">def</span> <span class="nf">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">choose_context1</span><span class="p">(</span><span class="n">context1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context1</span><span class="p">)</span>

    
<span class="k">def</span> <span class="nf">choose_context2</span><span class="p">(</span><span class="n">context2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VWCSimulation</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vw</span><span class="p">,</span> <span class="n">ictxt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span> <span class="o">=</span> <span class="n">vw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts1</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts2</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span> <span class="o">=</span> <span class="n">ictxt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">action</span><span class="p">),</span> \
                <span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ctxt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span> <span class="o">=</span> <span class="n">new_ctxt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">)</span>
        <span class="n">context1</span> <span class="o">=</span> <span class="n">choose_context1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts1</span><span class="p">)</span>
        <span class="n">context2</span> <span class="o">=</span> <span class="n">choose_context2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts2</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">:</span> <span class="n">context1</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">:</span> <span class="n">context2</span><span class="p">}</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">vw_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">finish_example</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">),</span><span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>
<span class="n">contextdf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">contextdf</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    56
1    16
Name: reward, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>
<span class="n">vws</span> <span class="o">=</span> <span class="n">VWCSimulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">contextdf</span><span class="p">)</span>

<span class="n">vws</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;usera&#39;, &#39;ctx12&#39;, &#39;ctx22&#39;, &#39;item2&#39;, 0, 0.16666666666666666)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_temp</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5000</span><span class="p">):</span>
    <span class="n">_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vws</span><span class="o">.</span><span class="n">step</span><span class="p">())</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">_temp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;context1&#39;</span><span class="p">,</span><span class="s1">&#39;context2&#39;</span><span class="p">,</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">])</span>


<span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span>
<span class="n">xx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>iter</th>
      <th>user</th>
      <th>context1</th>
      <th>context2</th>
      <th>item</th>
      <th>cost</th>
      <th>prob</th>
      <th>ccost</th>
      <th>ctr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1352</th>
      <td>1352</td>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item6</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-772</td>
      <td>0.571006</td>
    </tr>
    <tr>
      <th>2530</th>
      <td>2530</td>
      <td>usera</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item1</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1507</td>
      <td>0.595652</td>
    </tr>
    <tr>
      <th>581</th>
      <td>581</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-283</td>
      <td>0.487091</td>
    </tr>
    <tr>
      <th>4116</th>
      <td>4116</td>
      <td>userb</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item5</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2585</td>
      <td>0.628037</td>
    </tr>
    <tr>
      <th>2425</th>
      <td>2425</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item6</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1432</td>
      <td>0.590515</td>
    </tr>
    <tr>
      <th>3175</th>
      <td>3175</td>
      <td>usera</td>
      <td>ctx12</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1950</td>
      <td>0.614173</td>
    </tr>
    <tr>
      <th>1654</th>
      <td>1654</td>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>0</td>
      <td>0.833333</td>
      <td>-968</td>
      <td>0.585248</td>
    </tr>
    <tr>
      <th>4755</th>
      <td>4755</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item6</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-3018</td>
      <td>0.634700</td>
    </tr>
    <tr>
      <th>1857</th>
      <td>1857</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item6</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1093</td>
      <td>0.588584</td>
    </tr>
    <tr>
      <th>3771</th>
      <td>3771</td>
      <td>userb</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item1</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2367</td>
      <td>0.627685</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f31db251f50&gt;
</pre></div>
</div>
<img alt="_images/T119194_Contextual_RL_Product_Recommender_77_1.png" src="_images/T119194_Contextual_RL_Product_Recommender_77_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f31db1cfb90&gt;
</pre></div>
</div>
<img alt="_images/T119194_Contextual_RL_Product_Recommender_78_1.png" src="_images/T119194_Contextual_RL_Product_Recommender_78_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tempdf1</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;usera&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;item1&#39;</span><span class="p">),</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;userb&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;item2&#39;</span><span class="p">),</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;userc&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;item3&#39;</span><span class="p">),</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">X</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="n">vws</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">_temp</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5000</span><span class="p">):</span>
    <span class="n">_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vws</span><span class="o">.</span><span class="n">step</span><span class="p">())</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">_temp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;context1&#39;</span><span class="p">,</span><span class="s1">&#39;context2&#39;</span><span class="p">,</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">])</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span>
<span class="n">xx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>iter</th>
      <th>user</th>
      <th>context1</th>
      <th>context2</th>
      <th>item</th>
      <th>cost</th>
      <th>prob</th>
      <th>ccost</th>
      <th>ctr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4316</th>
      <td>4316</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item2</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-3412</td>
      <td>0.790547</td>
    </tr>
    <tr>
      <th>4798</th>
      <td>4798</td>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3827</td>
      <td>0.797624</td>
    </tr>
    <tr>
      <th>4154</th>
      <td>4154</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3284</td>
      <td>0.790563</td>
    </tr>
    <tr>
      <th>4720</th>
      <td>4720</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3757</td>
      <td>0.795975</td>
    </tr>
    <tr>
      <th>4362</th>
      <td>4362</td>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3448</td>
      <td>0.790463</td>
    </tr>
    <tr>
      <th>3520</th>
      <td>3520</td>
      <td>usera</td>
      <td>ctx12</td>
      <td>ctx21</td>
      <td>item1</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2759</td>
      <td>0.783807</td>
    </tr>
    <tr>
      <th>2614</th>
      <td>2614</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2025</td>
      <td>0.774675</td>
    </tr>
    <tr>
      <th>4840</th>
      <td>4840</td>
      <td>userb</td>
      <td>ctx12</td>
      <td>ctx21</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3863</td>
      <td>0.798140</td>
    </tr>
    <tr>
      <th>3084</th>
      <td>3084</td>
      <td>userc</td>
      <td>ctx12</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2414</td>
      <td>0.782750</td>
    </tr>
    <tr>
      <th>4921</th>
      <td>4921</td>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item4</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-3932</td>
      <td>0.799025</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tempdf2</span> <span class="o">=</span> <span class="n">tempdf1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tempdf2</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>iter</th>
      <th>user</th>
      <th>context1</th>
      <th>context2</th>
      <th>item</th>
      <th>cost</th>
      <th>prob</th>
      <th>ccost</th>
      <th>ctr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>974</th>
      <td>974</td>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item1</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-534</td>
      <td>0.548255</td>
    </tr>
    <tr>
      <th>5527</th>
      <td>527</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-292</td>
      <td>0.554080</td>
    </tr>
    <tr>
      <th>9055</th>
      <td>4055</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3199</td>
      <td>0.788903</td>
    </tr>
    <tr>
      <th>3984</th>
      <td>3984</td>
      <td>usera</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-2508</td>
      <td>0.629518</td>
    </tr>
    <tr>
      <th>2327</th>
      <td>2327</td>
      <td>userc</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item3</td>
      <td>0</td>
      <td>0.833333</td>
      <td>-1375</td>
      <td>0.590890</td>
    </tr>
    <tr>
      <th>6606</th>
      <td>1606</td>
      <td>usera</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item5</td>
      <td>0</td>
      <td>0.033333</td>
      <td>-1182</td>
      <td>0.735990</td>
    </tr>
    <tr>
      <th>7398</th>
      <td>2398</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx22</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1852</td>
      <td>0.772310</td>
    </tr>
    <tr>
      <th>9051</th>
      <td>4051</td>
      <td>userb</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-3195</td>
      <td>0.788694</td>
    </tr>
    <tr>
      <th>7105</th>
      <td>2105</td>
      <td>userb</td>
      <td>ctx11</td>
      <td>ctx21</td>
      <td>item2</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1603</td>
      <td>0.761520</td>
    </tr>
    <tr>
      <th>1866</th>
      <td>1866</td>
      <td>usera</td>
      <td>ctx12</td>
      <td>ctx22</td>
      <td>item1</td>
      <td>-1</td>
      <td>0.833333</td>
      <td>-1099</td>
      <td>0.588960</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tempdf2</span><span class="p">[</span><span class="s1">&#39;ccost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f31db191050&gt;
</pre></div>
</div>
<img alt="_images/T119194_Contextual_RL_Product_Recommender_81_1.png" src="_images/T119194_Contextual_RL_Product_Recommender_81_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tempdf2</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f31e9365790&gt;
</pre></div>
</div>
<img alt="_images/T119194_Contextual_RL_Product_Recommender_82_1.png" src="_images/T119194_Contextual_RL_Product_Recommender_82_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="contextual-bandit-dash-app">
<h2>Contextual bandit dash app<a class="headerlink" href="#contextual-bandit-dash-app" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Building a dash app of contextual bandit based recommender system</p>
</div></blockquote>
<p>The objective of this app is to apply the contextual bandit algorithms to recommendation problem under a simulated environment. The recommender agent is able to quickly adapt the changing behavior of users and change the recommendation strategy accordingly.</p>
<p>There are 3 users: Alex, Ben and Cindy. There are 6 news topics and 2 types of context. That means, Alex, Ben, and Cindy might prefer to read news reated to any of the 6 topics on morning/evening and weekday/weekends. Eg. Alex might prefer business related news on weekday mornings and entertainment related news on weekend evenings. And it is also possible that in future, Alex starts reading politics on weekday mornings. These situations reflect the real-world scenarios and the job of our contextual agent is to automatically detect these preferences and changes and recommend the items accordingly to maximize the reward like user satisfaction.</p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=9t0-FZIWMRQ">https://www.youtube.com/watch?v=9t0-FZIWMRQ</a></p>
<p>In the example, agent initialized with random preferences and starts recommending news to the users. We added 2 context: “Cindy prefers economy news on weekday mornings” and “Ben prefers weather news on weekday mornings” and starts rewarding agent for correctly recommending as per these preferences. At the moment, agent knows that Ben prefers business news and Cindy prefers history news. With time, agent started recommending weather news to Ben. Similar case we will see for Cindy and in fact, for all users.</p>
<p>Note: Interval is 1 sec but we are not seeing updates every second because we are looking at a particular context only: Weekday mornings but agent is recommending globally.</p>
<p>It is important to note that agent do not know the ground truth. It just taking action and receiving reward and the objective is to estimate this ground truth preferences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q dash dash-html-components dash-core-components dash_bootstrap_components jupyter-dash
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!mkdir -p assets
!wget -q --show-progress -O assets/image.jpg https://moodle.com/wp-content/uploads/2020/04/Moodle_General_news.png
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assets/image.jpg      0%[                    ]       0  --.-KB/s               
assets/image.jpg    100%[===================&gt;]  26.00K  --.-KB/s    in 0s      
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dash</span>
<span class="kn">from</span> <span class="nn">dash</span> <span class="kn">import</span> <span class="n">dcc</span>
<span class="kn">import</span> <span class="nn">dash_html_components</span> <span class="k">as</span> <span class="nn">html</span>
<span class="kn">import</span> <span class="nn">dash_bootstrap_components</span> <span class="k">as</span> <span class="nn">dbc</span>
<span class="kn">from</span> <span class="nn">dash.dependencies</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">jupyter_dash</span> <span class="kn">import</span> <span class="n">JupyterDash</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="kn">from</span> <span class="nn">vowpalwabbit</span> <span class="kn">import</span> <span class="n">pyvw</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function modifies (context, action, cost, probability) to VW friendly format</span>
<span class="k">def</span> <span class="nf">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">cb_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen_action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">cb_label</span>
    <span class="n">example_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;shared |User users=</span><span class="si">{}</span><span class="s2"> context1=</span><span class="si">{}</span><span class="s2"> context2=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context1&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context2&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cb_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="n">chosen_action</span><span class="p">:</span>
            <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;0:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">example_string</span> <span class="o">+=</span> <span class="s2">&quot;|Action items=</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="c1">#Strip the last newline</span>
    <span class="k">return</span> <span class="n">example_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf</span><span class="p">]</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">sum_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
        <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">prob</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sum_prob</span> <span class="o">&gt;</span> <span class="n">draw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">prob</span>


<span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="n">vw_text_example</span> <span class="o">=</span> <span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">vw</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">vw_text_example</span><span class="p">)</span>
    <span class="n">chosen_action_index</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">sample_custom_pmf</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actions</span><span class="p">[</span><span class="n">chosen_action_index</span><span class="p">],</span> <span class="n">prob</span>


<span class="k">def</span> <span class="nf">choose_user</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">choose_context1</span><span class="p">(</span><span class="n">context1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">choose_context2</span><span class="p">(</span><span class="n">context2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context2</span><span class="p">)</span>
    

<span class="k">class</span> <span class="nc">VWCSimulation</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vw</span><span class="p">,</span> <span class="n">ictxt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span> <span class="o">=</span> <span class="n">vw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts1</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts2</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">ictxt</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span> <span class="o">=</span> <span class="n">ictxt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">action</span><span class="p">),</span> \
                <span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ctxt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span> <span class="o">=</span> <span class="n">new_ctxt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">choose_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">)</span>
        <span class="n">context1</span> <span class="o">=</span> <span class="n">choose_context1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts1</span><span class="p">)</span>
        <span class="n">context2</span> <span class="o">=</span> <span class="n">choose_context2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts2</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">:</span> <span class="n">context1</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">:</span> <span class="n">context2</span><span class="p">}</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">vw_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_vw_example_format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)),</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">lContextualBandit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw</span><span class="o">.</span><span class="n">finish_example</span><span class="p">(</span><span class="n">vw_format</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;context1&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;context2&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">JupyterDash</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">external_stylesheets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">themes</span><span class="o">.</span><span class="n">BOOTSTRAP</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">generate_input_cards</span><span class="p">(</span><span class="n">preference</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">):</span>
    <span class="n">card_content</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dbc</span><span class="o">.</span><span class="n">CardImg</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;assets/image.jpg&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">dbc</span><span class="o">.</span><span class="n">CardBody</span><span class="p">([</span><span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">preference</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;card-title&quot;</span><span class="p">)])</span>
    <span class="p">]</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Card</span><span class="p">(</span><span class="n">card_content</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">([</span><span class="n">card</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="n">pref_grid</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">mapping_users</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Alex&#39;</span><span class="p">:</span><span class="s1">&#39;usera&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ben&#39;</span><span class="p">:</span><span class="s1">&#39;userb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cindy&#39;</span><span class="p">:</span> <span class="s1">&#39;userc&#39;</span>
<span class="p">}</span>
    
<span class="n">mapping_context1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Morning&#39;</span><span class="p">:</span><span class="s1">&#39;ctx11&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Evening&#39;</span><span class="p">:</span><span class="s1">&#39;ctx12&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">mapping_context2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Weekday&#39;</span><span class="p">:</span><span class="s1">&#39;ctx21&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Weekend&#39;</span><span class="p">:</span><span class="s1">&#39;ctx22&#39;</span>
<span class="p">}</span>

<span class="n">mapping_items</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Politics&#39;</span><span class="p">:</span><span class="s1">&#39;item1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Economics&#39;</span><span class="p">:</span><span class="s1">&#39;item2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Technology&#39;</span><span class="p">:</span><span class="s1">&#39;item3&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Weather&#39;</span><span class="p">:</span><span class="s1">&#39;item4&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Business&#39;</span><span class="p">:</span><span class="s1">&#39;item5&#39;</span><span class="p">,</span>
    <span class="s1">&#39;History&#39;</span><span class="p">:</span><span class="s1">&#39;item6&#39;</span>
<span class="p">}</span>

<span class="n">mapping_users_reverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_users</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">mapping_context1_reverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context1</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">mapping_context2_reverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context2</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">mapping_items_reverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_items</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_users</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">context1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_context1</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">context2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping_context2</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">context1</span><span class="p">,</span> <span class="n">context2</span><span class="p">,</span> <span class="n">items</span><span class="p">)),</span>
                       <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;context1&#39;</span><span class="p">,</span> <span class="s1">&#39;context2&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">])</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">),</span><span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>

<span class="n">vw</span> <span class="o">=</span> <span class="n">pyvw</span><span class="o">.</span><span class="n">vw</span><span class="p">(</span><span class="s2">&quot;--cb_explore_adf -q UA --quiet --epsilon 0.2&quot;</span><span class="p">)</span>
<span class="n">vws</span> <span class="o">=</span> <span class="n">VWCSimulation</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<span class="n">last_update</span> <span class="o">=</span> <span class="n">vws</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="n">contextdf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">countDF</span> <span class="o">=</span> <span class="n">contextdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">countDF</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">generate_input_boxes</span><span class="p">():</span>
    <span class="n">dropdown_users</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_users&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_users</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;usera&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dropdown_context1</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_ctx1&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context1</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;ctx11&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dropdown_context2</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_ctx2&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context2</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;ctx21&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dropdown_items</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_items&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_items</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;item1&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">dropdown_users</span><span class="p">,</span>
            <span class="n">dropdown_context1</span><span class="p">,</span>
            <span class="n">dropdown_context2</span><span class="p">,</span>
            <span class="n">dropdown_items</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;flex&quot;</span><span class="p">,</span> <span class="s2">&quot;flex-direction&quot;</span><span class="p">:</span> <span class="s2">&quot;column&quot;</span><span class="p">},</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_context_boxes</span><span class="p">():</span>
    <span class="n">dropdown_outcontext1</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_outctx1&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context1</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;ctx11&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dropdown_outcontext2</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ddown_outctx2&#39;</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping_context2</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;ctx21&quot;</span><span class="p">,</span>
        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">dropdown_outcontext1</span><span class="p">,</span>
            <span class="n">dropdown_outcontext2</span>
        <span class="p">],</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;flex&quot;</span><span class="p">,</span> <span class="s2">&quot;flex-direction&quot;</span><span class="p">:</span> <span class="s2">&quot;column&quot;</span><span class="p">},</span>
    <span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
        <span class="n">generate_input_boxes</span><span class="p">(),</span>
        <span class="n">dbc</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Register your Preference&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span> 
                   <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;pref-button&#39;</span><span class="p">),</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;pref-grid&#39;</span><span class="p">),</span>
        <span class="n">dbc</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Clear the context&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;secondary&quot;</span><span class="p">,</span> 
                   <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;clr-button&#39;</span><span class="p">),</span>
        <span class="n">dbc</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Start rewarding Agent for these Preferences&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> 
                   <span class="n">className</span><span class="o">=</span><span class="s2">&quot;m-1&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;updt-button&#39;</span><span class="p">),</span>
        <span class="n">generate_context_boxes</span><span class="p">(),</span>
        <span class="n">dcc</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;interval-component&#39;</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="c1"># in milliseconds</span>
            <span class="n">n_intervals</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;placeholder2&#39;</span><span class="p">),</span>

<span class="p">])</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
    <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;pref-grid&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;pref-button&quot;</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">),</span>   
    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;clr-button&quot;</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">),</span>
    <span class="n">State</span><span class="p">(</span><span class="s1">&#39;ddown_users&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
    <span class="n">State</span><span class="p">(</span><span class="s1">&#39;ddown_items&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
    <span class="n">State</span><span class="p">(</span><span class="s1">&#39;ddown_ctx1&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span> 
    <span class="n">State</span><span class="p">(</span><span class="s1">&#39;ddown_ctx2&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">update_pref_grid</span><span class="p">(</span><span class="n">nclick_pref</span><span class="p">,</span> <span class="n">nclick_clr</span><span class="p">,</span> <span class="n">pref_user</span><span class="p">,</span> <span class="n">pref_item</span><span class="p">,</span> <span class="n">pref_ctx1</span><span class="p">,</span> <span class="n">pref_ctx2</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">pref_grid</span>
    <span class="n">changed_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;prop_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dash</span><span class="o">.</span><span class="n">callback_context</span><span class="o">.</span><span class="n">triggered</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;pref-button&quot;</span> <span class="ow">in</span> <span class="n">changed_id</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">contextdf</span>
        <span class="n">card_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> prefers </span><span class="si">{}</span><span class="s1"> related news in </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mapping_users_reverse</span><span class="p">[</span><span class="n">pref_user</span><span class="p">],</span>
                                                  <span class="n">mapping_items_reverse</span><span class="p">[</span><span class="n">pref_item</span><span class="p">],</span>
                                                  <span class="n">mapping_context2_reverse</span><span class="p">[</span><span class="n">pref_ctx2</span><span class="p">],</span>
                                                  <span class="n">mapping_context1_reverse</span><span class="p">[</span><span class="n">pref_ctx1</span><span class="p">])</span>
        
        <span class="n">contextdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="n">pref_user</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">pref_ctx1</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">pref_ctx2</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">contextdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">users</span><span class="o">==</span><span class="n">pref_user</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">pref_ctx1</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">pref_ctx2</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">contextdf</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pref_item</span><span class="p">),</span> \
            <span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pref_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generate_input_cards</span><span class="p">(</span><span class="n">card_text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">pref_grid</span><span class="p">,</span>
                      <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max-width&#39;</span><span class="p">:</span> <span class="s1">&#39;100%&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;flex&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;align-items&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="s1">&#39;2rem 5rem&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;overflow&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="s1">&#39;fit-content&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;flex-direction&#39;</span><span class="p">:</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span>
                            <span class="p">})</span>
    <span class="k">elif</span> <span class="s2">&quot;clr-button&quot;</span> <span class="ow">in</span> <span class="n">changed_id</span><span class="p">:</span>
        <span class="n">pref_grid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">pref_grid</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
    <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;placeholder2&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;updt-button&quot;</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="n">nclick</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nclick</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">vws</span>
        <span class="k">global</span> <span class="n">contextdf</span>
        <span class="n">vws</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="n">contextdf</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
    <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
    <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;interval-component&#39;</span><span class="p">,</span> <span class="s1">&#39;n_intervals&#39;</span><span class="p">),</span>
    <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;ddown_outctx1&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span> 
    <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;ddown_outctx2&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">update_metrics</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">octx1</span><span class="p">,</span> <span class="n">octx2</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">countDF</span>
    <span class="n">countDF</span> <span class="o">=</span> <span class="n">countDF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vws</span><span class="o">.</span><span class="n">step</span><span class="p">(),</span><span class="n">countDF</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="n">countDF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="n">_x</span><span class="p">[(</span><span class="n">_x</span><span class="o">.</span><span class="n">context1</span><span class="o">==</span><span class="n">octx1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_x</span><span class="o">.</span><span class="n">context2</span><span class="o">==</span><span class="n">octx2</span><span class="p">)]</span>
    <span class="n">_x</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">*=-</span><span class="mi">1</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">],</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping_users_reverse</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pv</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapping_items_reverse</span><span class="p">)</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Preferences&quot;</span><span class="p">})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
        <span class="n">dbc</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">striped</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hover</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">responsive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">run_server</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8081</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">(async (port, path, width, height, cache, element) => {
    if (!google.colab.kernel.accessAllowed && !cache) {
      return;
    }
    element.appendChild(document.createTextNode(''));
    const url = await google.colab.kernel.proxyPort(port, {cache});
    const iframe = document.createElement('iframe');
    iframe.src = new URL(path, url).toString();
    iframe.height = height;
    iframe.width = width;
    iframe.style.border = 0;
    element.appendChild(iframe);
  })(8081, "/", "100%", 650, false, window.element)</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># !kill -9 $(lsof -t -i:8081) # command to kill the dash once done</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/drl-recsys",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T000348_Multi_armed_Bandit_for_Banner_Ad.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Multi-armed Bandit for Banner Ad</p>
            </div>
        </a>
    </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>